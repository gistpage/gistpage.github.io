<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gist JSON é…ç½®æŸ¥çœ‹å™¨</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1em; background: #f7f7f7; }
    .container { max-width: 480px; margin: 0 auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 1em; }
    .field { margin-bottom: 1em; }
    label { display: block; margin-bottom: 0.3em; font-weight: bold; }
    input, select, button { width: 100%; padding: 0.5em; font-size: 1em; border-radius: 4px; border: 1px solid #ccc; }
    button { background: #1677ff; color: #fff; border: none; cursor: pointer; margin-top: 1em; }
    button:disabled { background: #ccc; }
    .switch { width: 40px; height: 20px; }
    .msg { margin: 1em 0; color: #d46b08; }
    .json-group { border-left: 2px solid #eee; margin-left: 0.5em; padding-left: 0.5em; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Gist JSON é…ç½®æŸ¥çœ‹å™¨</h2>
    <div class="field">
      <label for="gistId">Gist é“¾æ¥æˆ– ID</label>
      <input id="gistId" placeholder="å¦‚ï¼ša1b2c3d4e5... æˆ– https://gist.github.com/xxx/yyy" autocomplete="off">
      <button type="button" onclick="loadDemo()" style="margin-top: 0.5em; background: #52c41a; width: auto; padding: 0.3em 1em; font-size: 0.9em;">åŠ è½½ç¤ºä¾‹</button>
    </div>
    <div class="field">
      <label for="token">GitHub Tokenï¼ˆå¯é€‰ï¼Œè®¿é—®ç§æœ‰ Gist æ—¶éœ€è¦ï¼‰</label>
      <input id="token" type="password" placeholder="Personal Access Token" autocomplete="off">
    </div>
    <button onclick="loadGist()">åŠ è½½ gist é…ç½®</button>
    
    <div style="margin: 1em 0; padding: 0.8em; background: #f6f8fa; border-radius: 6px; font-size: 0.9em; color: #656d76;">
      <strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong><br>
      â€¢ æ”¯æŒå…¬å¼€å’Œç§æœ‰ Gist<br>
      â€¢ ç§æœ‰ Gist éœ€è¦æä¾› GitHub Token<br>
      â€¢ è‡ªåŠ¨è¯†åˆ« .json æ–‡ä»¶å¹¶ç”Ÿæˆå¯ç¼–è¾‘è¡¨å•<br>
      â€¢ å¯ç›´æ¥åœ¨çº¿ç¼–è¾‘é…ç½®å¹¶å¯¼å‡º
    </div>
    
    <form id="jsonForm" onsubmit="event.preventDefault();"></form>
    <button id="exportBtn" onclick="exportJson()" type="button" style="display:none;">å¯¼å‡º JSON</button>
    <div id="msg" class="msg">è¯·è¾“å…¥ Gist ä¿¡æ¯å¹¶åŠ è½½ï¼Œæˆ–ç‚¹å‡»"åŠ è½½ç¤ºä¾‹"æµ‹è¯•åŠŸèƒ½</div>
  </div>
  <script>
    let currentJson = null;

    // åŠ è½½ç¤ºä¾‹ Gist
    function loadDemo() {
      // ä½¿ç”¨ä¸€ä¸ªå…¬å¼€çš„ç¤ºä¾‹ Gist IDï¼ŒåŒ…å« JSON é…ç½®
      document.getElementById('gistId').value = 'fa5c67b67b8f1b3c3aa7fa11d6a9f607';
      document.getElementById('token').value = '';
      showMsg('å·²åŠ è½½ç¤ºä¾‹ Gist IDï¼Œç‚¹å‡»"åŠ è½½ gist é…ç½®"æ¥æµ‹è¯•');
    }

    // é€’å½’æ¸²æŸ“ JSON ä¸ºè¡¨å•
    function renderJsonForm(json, container, path = []) {
      container.innerHTML = '';
      for (const key in json) {
        const value = json[key];
        const fieldPath = path.concat(key);
        const fieldId = 'field_' + fieldPath.join('_');
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'field';
        const label = document.createElement('label');
        label.textContent = key;
        label.htmlFor = fieldId;
        fieldDiv.appendChild(label);
        if (typeof value === 'boolean') {
          // Switch
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.id = fieldId;
          input.checked = value;
          input.onchange = () => setValueByPath(currentJson, fieldPath, input.checked);
          fieldDiv.appendChild(input);
        } else if (typeof value === 'number' || typeof value === 'string') {
          // æ–‡æœ¬è¾“å…¥
          const input = document.createElement('input');
          input.type = typeof value === 'number' ? 'number' : 'text';
          input.id = fieldId;
          input.value = value;
          input.oninput = () => setValueByPath(currentJson, fieldPath, input.type === 'number' ? Number(input.value) : input.value);
          fieldDiv.appendChild(input);
        } else if (Array.isArray(value)) {
          // æ•°ç»„é€’å½’
          const group = document.createElement('div');
          group.className = 'json-group';
          value.forEach((item, idx) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'field';
            const itemLabel = document.createElement('label');
            itemLabel.textContent = key + '[' + idx + ']';
            itemDiv.appendChild(itemLabel);
            if (typeof item === 'object' && item !== null) {
              renderJsonForm(item, itemDiv, fieldPath.concat(idx));
            } else {
              const input = document.createElement('input');
              input.type = typeof item === 'number' ? 'number' : 'text';
              input.value = item;
              input.oninput = () => setValueByPath(currentJson, fieldPath.concat(idx), input.type === 'number' ? Number(input.value) : input.value);
              itemDiv.appendChild(input);
            }
            group.appendChild(itemDiv);
          });
          fieldDiv.appendChild(group);
        } else if (typeof value === 'object' && value !== null) {
          // åµŒå¥—å¯¹è±¡é€’å½’
          const group = document.createElement('div');
          group.className = 'json-group';
          renderJsonForm(value, group, fieldPath);
          fieldDiv.appendChild(group);
        } else {
          // å…¶ä»–ç±»å‹åªè¯»
          const span = document.createElement('span');
          span.textContent = String(value);
          fieldDiv.appendChild(span);
        }
        container.appendChild(fieldDiv);
      }
    }

    // æ ¹æ®è·¯å¾„è®¾ç½®å€¼
    function setValueByPath(obj, path, value) {
      let o = obj;
      for (let i = 0; i < path.length - 1; i++) {
        o = o[path[i]];
      }
      o[path[path.length - 1]] = value;
    }

    // å¯¼å‡º JSON æ–‡ä»¶
    function exportJson() {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentJson, null, 2));
      const dlAnchor = document.createElement('a');
      dlAnchor.setAttribute("href", dataStr);
      dlAnchor.setAttribute("download", "config.json");
      document.body.appendChild(dlAnchor);
      dlAnchor.click();
      document.body.removeChild(dlAnchor);
      showMsg('å·²å¯¼å‡º JSON æ–‡ä»¶');
    }

    // è§£æ gistId æˆ– url
    function parseGistId(input) {
      if (!input) return '';
      if (/^[a-f0-9]{8,}$/i.test(input)) return input;
      const m = input.match(/gist\.github\.com\/(?:[^\/]+\/)?([a-f0-9]{8,})/i);
      return m ? m[1] : '';
    }

    // åŠ è½½ gist é…ç½®
    async function loadGist() {
      const gistInput = document.getElementById('gistId').value.trim();
      const token = document.getElementById('token').value.trim();
      const gistId = parseGistId(gistInput);
      if (!gistId) return showMsg('è¯·è¾“å…¥æœ‰æ•ˆçš„ Gist é“¾æ¥æˆ– ID');
      showMsg('åŠ è½½ä¸­...');
      
      try {
        // æ„å»ºè¯·æ±‚å¤´
        const headers = {
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'Gist-JSON-Viewer/1.0'
        };
        
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        // ç¬¬ä¸€æ­¥ï¼šè·å– Gist ä¿¡æ¯
        const res = await fetch(`https://api.github.com/gists/${gistId}`, {
          method: 'GET',
          headers: headers,
          mode: 'cors'
        });
        
        if (!res.ok) {
          if (res.status === 404) {
            showMsg('Gist ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®');
          } else if (res.status === 403) {
            showMsg('è®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥ Token æƒé™');
          } else if (res.status === 401) {
            showMsg('è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®');
          } else {
            showMsg(`Gist åŠ è½½å¤±è´¥ï¼š${res.status} ${res.statusText}`);
          }
          return;
        }
        
        const data = await res.json();
        
        // æ‰¾åˆ°ç¬¬ä¸€ä¸ª JSON æ–‡ä»¶
        const fileEntry = Object.entries(data.files).find(([k, v]) => 
          v.language === 'JSON' || k.toLowerCase().endsWith('.json')
        );
        
        if (!fileEntry) {
          showMsg('æœªæ‰¾åˆ° JSON æ–‡ä»¶ï¼Œè¯·ç¡®ä¿ Gist ä¸­åŒ…å« .json æ–‡ä»¶');
          return;
        }
        
        const fileName = fileEntry[0];
        const fileInfo = fileEntry[1];
        
        showMsg(`æ‰¾åˆ°æ–‡ä»¶ï¼š${fileName}ï¼Œæ­£åœ¨åŠ è½½å†…å®¹...`);
        
        // ç¬¬äºŒæ­¥ï¼šè·å–æ–‡ä»¶å†…å®¹
        let jsonText;
        if (fileInfo.content) {
          // å¦‚æœå†…å®¹å·²ç»åœ¨å“åº”ä¸­ï¼ˆå°æ–‡ä»¶ï¼‰
          jsonText = fileInfo.content;
        } else {
          // å¦‚æœéœ€è¦ä» raw_url è·å–ï¼ˆå¤§æ–‡ä»¶ï¼‰
          const rawRes = await fetch(fileInfo.raw_url, {
            method: 'GET',
            headers: headers,
            mode: 'cors'
          });
          
          if (!rawRes.ok) {
            showMsg(`JSON æ–‡ä»¶åŠ è½½å¤±è´¥ï¼š${rawRes.status} ${rawRes.statusText}`);
            return;
          }
          
          jsonText = await rawRes.text();
        }
        
        // ç¬¬ä¸‰æ­¥ï¼šè§£æ JSON
        try {
          currentJson = JSON.parse(jsonText);
        } catch (e) {
          showMsg(`JSON è§£æå¤±è´¥ï¼š${e.message}ã€‚è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚`);
          return;
        }
        
        // ç¬¬å››æ­¥ï¼šæ¸²æŸ“è¡¨å•
        renderJsonForm(currentJson, document.getElementById('jsonForm'));
        document.getElementById('exportBtn').style.display = '';
        showMsg(`åŠ è½½æˆåŠŸï¼æ–‡ä»¶ï¼š${fileName}ï¼Œå…± ${Object.keys(currentJson).length} ä¸ªé…ç½®é¡¹`);
        
      } catch (e) {
        console.error('åŠ è½½ Gist æ—¶å‘ç”Ÿé”™è¯¯:', e);
        
        if (e.name === 'TypeError' && e.message.includes('fetch')) {
          showMsg('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š1) ç½‘ç»œè¿æ¥ 2) æ˜¯å¦è¢«é˜²ç«å¢™é˜»æ­¢ 3) Gist ID æ˜¯å¦æ­£ç¡®');
        } else if (e.message.includes('CORS')) {
          showMsg('è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢ï¼Œè¯·å°è¯•ä½¿ç”¨ GitHub Token æˆ–ç¨åå†è¯•');
        } else {
          showMsg(`ç½‘ç»œå¼‚å¸¸ï¼š${e.message}`);
        }
      }
    }

    // æ¶ˆæ¯æç¤º
    function showMsg(msg) {
      document.getElementById('msg').textContent = msg;
    }
  </script>
</body>
</html> 