<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>应用配置管理平台</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚙️</text></svg>">
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%); 
      min-height: 100vh; 
      position: relative;
    }
    
    /* 登录页面隐藏滚动条，管理页面允许滚动 */
    html, body {
      height: 100%;
    }
    /* 登录页面隐藏滚动条 */
    #loginPage::-webkit-scrollbar {
      display: none;
    }
    #loginPage {
      -ms-overflow-style: none;
      scrollbar-width: none;
      overflow: hidden;
    }
    
    /* 管理页面的美化滚动条 */
    #editPage .admin-content {
      scrollbar-width: thin;
      scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
    }
    #editPage .admin-content::-webkit-scrollbar {
      width: 6px;
    }
    #editPage .admin-content::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 3px;
    }
    #editPage .admin-content::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.3);
      border-radius: 3px;
      min-height: 20px;
    }
    #editPage .admin-content::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.5);
    }
    #editPage .admin-content::-webkit-scrollbar-corner {
      background: transparent;
    }
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(ellipse at center, rgba(255,255,255,0.1) 0%, transparent 70%);
      pointer-events: none;
    }
    body::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent);
      animation: backgroundMove 15s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes backgroundMove {
      0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(0deg); }
      50% { transform: translateX(0%) translateY(0%) rotate(180deg); }
    }
    .login-container { 
      max-width: 420px; 
      margin: 0 auto; 
      padding: 1.2em; 
      height: 100vh; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      overflow: hidden; 
      box-sizing: border-box;
    }
    .admin-container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background: #f8fafc; 
      min-height: 100vh; 
      display: flex; 
      flex-direction: column; 
      padding-bottom: 0;
    }
    .login-card { 
      background: rgba(255, 255, 255, 0.95); 
      backdrop-filter: blur(15px);
      border-radius: 16px; 
      box-shadow: 0 30px 60px rgba(0,0,0,0.12), 0 10px 20px rgba(0,0,0,0.08); 
      padding: 1.8em 2em; 
      text-align: center; 
      max-height: 95vh; 
      border: 1px solid rgba(255,255,255,0.3);
      position: relative;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .admin-header { background: #fff; border-bottom: 1px solid #e2e8f0; padding: 1em 2em; flex-shrink: 0; }
    .admin-content { padding: 1em 2em 1.5em 2em; flex: 1; overflow-y: auto; scroll-behavior: smooth; }
    .field { margin-bottom: 0.8em; }
    .field:last-of-type { margin-bottom: 1em; }
    label { 
      display: block; 
      margin-bottom: 0.5em; 
      font-weight: 600; 
      color: #374151; 
      font-size: 0.9em; 
      text-align: left;
    }
    input { 
      width: 100%; 
      padding: 0.7em 1em; 
      font-size: 1em; 
      border-radius: 10px; 
      border: 2px solid #e5e7eb; 
      box-sizing: border-box; 
      transition: all 0.3s ease; 
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px);
    }
    input:focus { 
      outline: none; 
      border-color: #667eea; 
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); 
      background: rgba(255, 255, 255, 1);
      transform: translateY(-1px);
    }
    input::placeholder {
      color: #9ca3af;
      font-size: 0.95em;
    }
    .login-btn { 
      width: 100%; 
      padding: 0.9em 1.2em; 
      font-size: 1.05em; 
      border-radius: 10px; 
      border: none; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: #fff; 
      cursor: pointer; 
      font-weight: 600; 
      transition: all 0.3s ease;
      margin-top: 0.3em;
      position: relative;
      overflow: hidden;
    }
    .login-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .login-btn:hover::before {
      left: 100%;
    }
    .login-btn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
    }
    .login-btn:active {
      transform: translateY(0);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    .login-btn:disabled { 
      background: #9ca3af; 
      cursor: not-allowed; 
      transform: none; 
      box-shadow: none; 
    }
    .login-btn:disabled::before {
      display: none;
    }
    .admin-btn { padding: 0.5em 1.2em; font-size: 0.9em; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s; }
    .btn-primary { background: #667eea; color: #fff; }
    .btn-primary:hover { background: #5a67d8; }
    .btn-success { background: #10b981; color: #fff; }
    .btn-success:hover { background: #059669; }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-danger:hover { background: #dc2626; }
    .btn-secondary { background: #6b7280; color: #fff; }
    .btn-secondary:hover { background: #4b5563; }
    button:disabled { background: #9ca3af !important; cursor: not-allowed; transform: none; }
    
    /* 后台管理样式 */
    .system-logo { 
      font-size: 2.2em; 
      font-weight: 700; 
      color: #667eea; 
      margin-bottom: 0.3em; 
      text-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
    }
    .system-title { 
      font-size: 1.6em; 
      font-weight: 700; 
      color: #1f2937; 
      margin-bottom: 0.3em; 
      letter-spacing: -0.5px;
      line-height: 1.2;
    }
    .system-desc { 
      color: #6b7280; 
      font-size: 0.95em; 
      margin-bottom: 1.2em; 
      line-height: 1.4;
      font-weight: 400;
    }
    .admin-title { display: flex; align-items: center; justify-content: space-between; }
    .admin-title h2 { margin: 0; color: #1f2937; font-size: 1.4em; font-weight: 600; }
    .admin-user { display: flex; align-items: center; gap: 0.5em; color: #6b7280; font-size: 0.9em; }
    .config-panel { background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1em; margin-bottom: 0.8em; }
    .panel-title { font-size: 1.1em; font-weight: 600; color: #1f2937; margin-bottom: 0.6em; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.3em; }
    
    /* 开关样式 */
    .switch-container { display: flex; align-items: center; gap: 1em; margin: 0.5em 0; }
    .switch { position: relative; display: inline-block; width: 60px; height: 32px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 32px; }
    .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    input:checked + .slider { background-color: #667eea; }
    input:checked + .slider:before { transform: translateX(28px); }
    .switch-label { font-weight: 600; color: #374151; }
    .switch-status { font-size: 0.85em; padding: 0.3em 0.8em; border-radius: 20px; font-weight: 500; }
    .switch-status.enabled { background: #d1fae5; color: #065f46; }
    .switch-status.disabled { background: #fee2e2; color: #991b1b; }
    
    /* URL输入优化样式 */
    .url-input-container { display: flex; gap: 0.5em; align-items: stretch; }
    .url-input-container input { flex: 1; margin: 0; }
    .test-url-btn, .clear-url-btn { width: 42px; padding: 0.6em; border-radius: 6px; cursor: pointer; font-size: 1em; transition: all 0.2s; border: none; }
    .test-url-btn { background: #dbeafe; color: #1d4ed8; }
    .test-url-btn:hover { background: #bfdbfe; }
    .test-url-btn:disabled { background: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
    .clear-url-btn { background: #fecaca; color: #dc2626; }
    .clear-url-btn:hover { background: #fca5a5; }
    .clear-url-btn:disabled { background: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
    
    .url-validation { margin-top: 0.6em; padding: 0.6em; border-radius: 8px; font-size: 0.9em; border-left: 4px solid; }
    .url-validation.valid { background: #ecfdf5; color: #065f46; border-left-color: #10b981; }
    .url-validation.invalid { background: #fef2f2; color: #991b1b; border-left-color: #ef4444; }
    .url-validation.testing { background: #eff6ff; color: #1e40af; border-left-color: #3b82f6; }
    
    .quick-urls { margin-top: 0.8em; padding: 1em; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; }
    .url-buttons { display: flex; flex-wrap: wrap; gap: 0.4em; }
    .quick-url-btn { padding: 0.4em 0.8em; background: #fff; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 0.8em; transition: all 0.2s; color: #374151; font-weight: 500; }
    .quick-url-btn:hover { border-color: #667eea; color: #667eea; background: #f8faff; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .quick-url-btn:active { transform: translateY(0); }
    
    /* 响应式布局 */
    @media (max-width: 768px) {
      body::after {
        animation-duration: 20s; /* 移动设备上动画稍慢 */
      }
      .login-container { 
        padding: 1em; 
        height: 100vh;
        overflow: hidden;
      }
      .admin-container { margin: 0; }
      .admin-header { padding: 1em; }
      .admin-content { padding: 1em; }
      .url-buttons { flex-direction: column; }
      .quick-url-btn { text-align: center; }
      .url-input-container { flex-direction: column; }
      .test-url-btn, .clear-url-btn { width: 100%; margin-top: 0.5em; }
      .admin-title { flex-direction: column; align-items: flex-start; gap: 1em; }
      .login-card { 
        padding: 1.5em 1.2em; 
        background: rgba(255, 255, 255, 0.98); /* 移动设备上更高不透明度 */
        backdrop-filter: blur(5px); /* 移动设备上减少模糊 */
        border-radius: 14px;
      }
      .system-logo { font-size: 1.8em; }
      .system-title { font-size: 1.3em; }
      .system-desc { font-size: 0.9em; }
    .field { margin-bottom: 1em; }
      .field:last-of-type { margin-bottom: 1.2em; }
      input { 
        padding: 0.7em 0.9em; 
        font-size: 0.95em; 
      }
      .login-btn { 
        padding: 0.8em 1em; 
        font-size: 1em; 
      }
      .security-notice {
        padding: 0.7em;
        margin-bottom: 1em;
      }
      .footer-info {
        margin-top: 0.8em;
        padding-top: 0.8em;
      }
      .version {
        font-size: 0.8em;
      }
      .copyright {
        font-size: 0.75em;
      }
    }
    
    .msg { margin: 0.8em 0; padding: 0.7em; border-radius: 8px; font-weight: 500; border-left: 4px solid; }
    .msg.success { background: #ecfdf5; color: #065f46; border-left-color: #10b981; }
    .msg.error { background: #fef2f2; color: #991b1b; border-left-color: #ef4444; }
    .msg.info { background: #eff6ff; color: #1e40af; border-left-color: #3b82f6; }
    .msg.warning { background: #fffbeb; color: #92400e; border-left-color: #f59e0b; }
    .page { display: none; }
    .page.active { display: block; }
    .button-group { display: flex; gap: 1em; margin-top: 1em; }
    .button-group .admin-btn { flex: 1; }
    .config-preview { background: #f8fafc; border-radius: 12px; padding: 1em; margin: 0.8em 0; border: 1px solid #e2e8f0; }
    .config-preview h4 { margin: 0 0 0.6em 0; color: #374151; font-size: 1em; font-weight: 600; }
    .config-json { font-family: 'Monaco', 'Menlo', monospace; background: #fff; padding: 0.8em; border-radius: 8px; border: 1px solid #d1d5db; font-size: 0.9em; line-height: 1.5; }
    .config-summary { background: #fff; padding: 0; border-radius: 8px; border: 1px solid #d1d5db; }
    .summary-item { display: flex; align-items: center; justify-content: space-between; padding: 0.6em 1em; border-bottom: 1px solid #f3f4f6; transition: background-color 0.2s ease; }
    .summary-item:last-child { border-bottom: none; }
    .summary-item:hover { background-color: #f8fafc; }
    .summary-label { font-weight: 600; color: #374151; font-size: 0.9em; }
    .summary-value { font-weight: 600; font-size: 0.9em; }
    
    /* 配置读取机制样式 */
    .config-mechanism { background: #f1f5f9; border-radius: 12px; padding: 0; margin: 0.8em 0; border: 1px solid #cbd5e1; overflow: hidden; }
    .mechanism-header { display: flex; align-items: center; justify-content: space-between; padding: 1em; cursor: pointer; transition: all 0.2s ease; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border-bottom: 1px solid #cbd5e1; }
    .mechanism-header:hover { background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); }
    .mechanism-header h4 { margin: 0; color: #374151; font-size: 1em; font-weight: 600; }
    .mechanism-toggle { font-size: 0.8em; color: #6b7280; font-weight: 600; transition: transform 0.3s ease; }
    .mechanism-toggle.expanded { transform: rotate(180deg); }
    .mechanism-content { background: #fff; padding: 1em; animation: slideDown 0.3s ease-out; }
    .mechanism-section { margin-bottom: 1em; }
    .mechanism-section:last-child { margin-bottom: 0; }
    .mechanism-section h5 { margin: 0 0 0.6em 0; color: #1f2937; font-size: 0.95em; font-weight: 600; padding-bottom: 0.3em; border-bottom: 1px solid #e5e7eb; }
    .mechanism-items { display: flex; flex-direction: column; gap: 0.4em; }
    .mechanism-item { display: flex; align-items: center; padding: 0.5em 0; }
    .item-label { font-weight: 500; color: #4b5563; font-size: 0.85em; min-width: 140px; }
    .item-value { font-weight: 600; color: #1f2937; font-size: 0.85em; background: #f8fafc; padding: 0.2em 0.6em; border-radius: 4px; }
    
    /* 流程图样式 */
    .flow-diagram { display: flex; flex-direction: column; align-items: center; gap: 0.5em; padding: 0.8em; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
    .flow-step { background: #3b82f6; color: #fff; padding: 0.5em 1em; border-radius: 6px; font-size: 0.85em; font-weight: 600; text-align: center; }
    .flow-arrow { color: #6b7280; font-size: 1.2em; font-weight: 600; }
    .flow-branch { width: 100%; }
    .flow-path { display: flex; align-items: center; justify-content: center; gap: 0.6em; padding: 0.3em; }
    .flow-condition { background: #fbbf24; color: #92400e; padding: 0.3em 0.6em; border-radius: 4px; font-size: 0.8em; font-weight: 600; }
    .flow-arrow-right { color: #6b7280; font-size: 1em; font-weight: 600; }
    .flow-result { background: #10b981; color: #fff; padding: 0.3em 0.6em; border-radius: 4px; font-size: 0.8em; font-weight: 600; }
    
    /* 展开动画 */
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* 移动端适配 */
    @media (max-width: 768px) {
      .mechanism-header { padding: 0.8em; }
      .mechanism-header h4 { font-size: 0.9em; }
      .mechanism-content { padding: 0.8em; }
      .flow-path { flex-direction: column; gap: 0.3em; text-align: center; }
      .flow-arrow-right { transform: rotate(90deg); }
      .item-label { min-width: auto; margin-bottom: 0.2em; }
      .mechanism-item { flex-direction: column; align-items: flex-start; padding: 0.4em 0; }
    }
    .security-notice { 
      background: linear-gradient(135deg, #fef3c7 0%, #fef3c7 100%); 
      border: 1px solid #f59e0b; 
      border-radius: 10px; 
      padding: 0.8em; 
      margin-bottom: 1.2em; 
      position: relative;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.1);
      text-align: left;
    }
    .security-notice::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #f59e0b, #d97706, #f59e0b);
      border-radius: 12px 12px 0 0;
    }
    .security-notice .icon { 
      color: #d97706; 
      font-size: 1.3em; 
      margin-right: 0.6em; 
      vertical-align: middle;
    }
    .security-notice strong {
      color: #92400e;
      font-weight: 600;
    }
    
    /* 主要内容区域 */
    .login-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 0;
    }
    
    /* 版权信息样式 */
    .footer-info {
      text-align: center; 
      margin-top: 1.2em; 
      padding-top: 1.2em; 
      border-top: 1px solid rgba(229, 231, 235, 0.6); 
      position: relative;
      flex-shrink: 0;
    }
    .footer-info::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 1px;
      background: linear-gradient(90deg, transparent, #667eea, transparent);
    }
    .version {
      margin: 0 0 0.4em 0;
      color: #6b7280;
      font-size: 0.85em;
      font-weight: 500;
    }
    .copyright {
      margin: 0;
      color: #9ca3af;
      font-size: 0.8em;
      font-weight: 400;
      letter-spacing: 0.2px;
    }
    
    /* 登录页面动画效果 */
    .login-card { 
      animation: slideUp 0.8s ease-out; 
    }
    @keyframes slideUp { 
      from { opacity: 0; transform: translateY(30px) scale(0.98); } 
      to { opacity: 1; transform: translateY(0) scale(1); } 
    }
    
    /* 输入框浮动标签效果 */
    .field {
      position: relative;
    }
    .field label {
      transition: all 0.3s ease;
    }
    .field input:focus + label,
    .field input:not(:placeholder-shown) + label {
      transform: translateY(-0.5em);
      font-size: 0.85em;
      color: #667eea;
    }
    
    /* 增强的聚焦效果 */
    input:focus {
      animation: focusGlow 0.4s ease;
    }
    @keyframes focusGlow {
      0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.1); }
      50% { box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.15); }
      100% { box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); }
    }
    
    /* 页面过渡动画 */
    .page { transition: opacity 0.3s ease-in-out; }
    .page:not(.active) { opacity: 0; }
    .page.active { opacity: 1; }
    
    /* 按钮状态动画 */
    .login-btn.success { 
      animation: pulse 0.3s ease-in-out; 
    }
    @keyframes pulse { 
      0% { transform: scale(1); } 
      50% { transform: scale(1.02); } 
      100% { transform: scale(1); } 
    }
    
    /* 加载状态动画 */
    .login-btn.loading {
      position: relative;
      color: transparent;
    }
    .login-btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* 错误状态抖动动画 */
    .login-btn.error {
      animation: shake 0.5s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
      20%, 40%, 60%, 80% { transform: translateX(3px); }
    }
  </style>
</head>
<body>
  <!-- 登录页面 -->
  <div id="loginPage" class="page active">
    <div class="login-container">
      <div class="login-card">
        <div class="login-main">
          <div class="system-logo">⚙️</div>
          <h1 class="system-title">应用配置管理平台</h1>
          <p class="system-desc">集中管理和配置您的应用参数，安全、高效、可靠</p>
          
          <div class="security-notice">
            <span class="icon">🔒</span>
            <strong>安全提示：</strong>请确保您的访问凭据安全，平台采用端到端加密保护您的数据
          </div>
          
          <div class="field">
            <label for="gistId">App ID</label>
            <input id="gistId" placeholder="请输入您的应用标识符" autocomplete="off">
          </div>
          
    <div class="field">
            <label for="token">访问令牌</label>
            <input id="token" type="password" placeholder="请输入您的访问令牌" autocomplete="off">
          </div>
          
          <button onclick="connectToGist()" id="connectBtn" class="login-btn">连接到APP应用</button>
          
          <div id="loginMsg" class="msg info" style="display:none;"></div>
        </div>
        
        <div class="footer-info">
          <p class="version">应用配置管理平台 v2.1.0</p>
          <p class="copyright">© 2024 Enterprise Config Solutions</p>
        </div>
      </div>
    </div>
  </div>

    <!-- 管理页面 -->
    <div id="editPage" class="page">
      <div class="admin-container">
        <div class="admin-header">
          <div class="admin-title">
            <h2>🎛️ 应用配置控制台</h2>
            <div class="admin-user">
              <span>🟢 连接状态：<span style="color: #10b981; font-weight: 600;">已连接</span></span>
              <span style="margin-left: 2em;">📊 App ID：<span id="currentAppId" style="color: #6b7280; font-weight: 600; font-family: monospace;">-</span></span>
            </div>
          </div>
        </div>
        
        <div class="admin-content">
          <div class="config-panel">
            <div class="panel-title">⚙️ 应用版本配置</div>
            
            <div class="field">
              <label for="versionInput">应用版本号</label>
              <input type="number" id="versionInput" placeholder="例如：1" min="1" oninput="updateVersion()" onblur="updateVersion()">
              <div id="versionValidation" class="url-validation" style="display: none;"></div>
              <small style="color: #6b7280; margin-top: 0.5em; display: block;">
                应用的版本标识，只能设置为递增的整数（1, 2, 3...），用于版本管理和兼容性控制
              </small>
            </div>
          </div>

          <div class="config-panel">
            <div class="panel-title">🌐 页面重定向管理</div>
            
            <div class="field">
              <label class="switch-label">重定向功能状态</label>
              <div class="switch-container">
                <label class="switch">
                  <input type="checkbox" id="redirectEnabled" onchange="updateRedirectEnabled()">
                  <span class="slider"></span>
                </label>
                <span id="redirectStatus" class="switch-status enabled">已启用</span>
              </div>
              <small style="color: #6b7280; margin-top: 0.5em; display: block;">
                开启后，用户访问页面将自动跳转到指定地址
              </small>
            </div>
      
    <div class="field">
              <label for="redirectUrlInput">目标跳转地址 <span style="color: #ef4444;">*</span></label>
              <div class="url-input-container">
                <input type="url" id="redirectUrlInput" placeholder="输入网址，如：example.com" oninput="updateRedirectUrl()" onblur="validateUrl()" required>
                <button type="button" class="clear-url-btn" onclick="clearUrl()" id="clearBtn" title="重置为默认地址">🔄</button>
                <button type="button" class="test-url-btn" onclick="testUrl()" id="testBtn" title="测试链接">🔗</button>
              </div>
              <div id="urlValidation" class="url-validation" style="display: none;"></div>
              
              <div class="quick-urls">
                <label style="font-size: 0.9em; color: #6b7280; margin-bottom: 0.8em; display: block; font-weight: 600;">⚡ 快速配置模板：</label>
                <div class="url-buttons">
                  <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://flutter.dev/')">Flutter</button>
                  <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://github.com/')">GitHub</button>
                  <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://docs.flutter.dev/')">Flutter文档</button>
                  <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://pub.dev/')">Pub.dev</button>
                  <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://developer.android.com/')">Android</button>
                  <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://developer.apple.com/')">iOS</button>
                  <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://stackoverflow.com/')">Stack Overflow</button>
                  <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://npmjs.com/')">npm</button>
                  <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://www.google.com/')">Google</button>
                  <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://www.bilibili.com/')">哔哩哔哩</button>
                </div>
              </div>
              
              <small style="color: #6b7280; margin-top: 1em; display: block;">
                💡 提示：此字段为必填项，支持任何有效的网址，系统会自动验证链接的可访问性
              </small>
            </div>
          </div>
      
          <div class="config-preview">
            <h4>📋 配置概览</h4>
            <div class="config-summary">
              <div class="summary-item">
                <span class="summary-label">📦 应用版本：</span>
                <span id="previewVersionText" class="summary-value" style="color: #9333ea;">第 1 版</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">🔄 重定向功能：</span>
                <span id="previewEnabledText" class="summary-value" style="color: #ef4444;">已关闭</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">🎯 跳转目标：</span>
                <span id="previewUrlText" class="summary-value" style="color: #1d4ed8;">https://example.com</span>
              </div>
            </div>
          </div>

          <div class="config-mechanism">
            <div class="mechanism-header" onclick="toggleConfigMechanism()">
              <h4>📖 配置读取机制</h4>
              <span id="mechanismToggle" class="mechanism-toggle">▼</span>
            </div>
            <div id="mechanismContent" class="mechanism-content" style="display: none;">
              <div class="mechanism-section">
                <h5>🔄 读取时机</h5>
                <div class="mechanism-items">
                  <div class="mechanism-item">
                    <span class="item-label">应用启动:</span>
                    <span class="item-value">立即检查</span>
                  </div>
                  <div class="mechanism-item">
                    <span class="item-label">恢复前台:</span>
                    <span class="item-value">立即检查</span>
                  </div>
                  <div class="mechanism-item">
                    <span class="item-label">定时检查:</span>
                    <span class="item-value">前台2分钟间隔</span>
                  </div>
                </div>
              </div>

              <div class="mechanism-section">
                <h5>🔍 版本号比较机制</h5>
                <div class="mechanism-items">
                  <div class="mechanism-item">
                    <span class="item-label">获取本地版本号:</span>
                    <span class="item-value">从缓存读取</span>
                  </div>
                  <div class="mechanism-item">
                    <span class="item-label">轻量级检查远程版本:</span>
                    <span class="item-value">使用ETag优化</span>
                  </div>
                  <div class="mechanism-item">
                    <span class="item-label">版本号对比:</span>
                    <span class="item-value">不同则触发更新</span>
                  </div>
                  <div class="mechanism-item">
                    <span class="item-label">完整配置下载:</span>
                    <span class="item-value">仅在版本变化时</span>
                  </div>
                </div>
              </div>

              <div class="mechanism-section">
                <h5>📊 读取流程</h5>
                <div class="flow-diagram">
                  <div class="flow-step">本地版本 vs 远程版本</div>
                  <div class="flow-arrow">↓</div>
                  <div class="flow-branch">
                    <div class="flow-path">
                      <span class="flow-condition">版本相同</span>
                      <span class="flow-arrow-right">→</span>
                      <span class="flow-result">使用缓存</span>
                    </div>
                  </div>
                  <div class="flow-arrow">↓</div>
                  <div class="flow-branch">
                    <div class="flow-path">
                      <span class="flow-condition">版本不同</span>
                      <span class="flow-arrow-right">→</span>
                      <span class="flow-result">下载新配置</span>
                    </div>
                  </div>
                  <div class="flow-arrow">↓</div>
                  <div class="flow-branch">
                    <div class="flow-path">
                      <span class="flow-condition">网络失败</span>
                      <span class="flow-arrow-right">→</span>
                      <span class="flow-result">使用缓存/默认</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="button-group">
            <button onclick="saveToGist()" id="saveBtn" class="admin-btn btn-success">💾 保存配置</button>
            <button onclick="backToLogin()" class="admin-btn btn-danger">🚪 退出APP应用</button>
          </div>
          
          <div id="editMsg" class="msg info" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // 全局状态
    let currentJson = null;
    let currentGistId = null;
    let currentToken = null;
    let currentFileName = null;
    let currentFileInfo = null;

    // 页面切换
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
    }

    // 配置读取机制展开/折叠
    function toggleConfigMechanism() {
      const content = document.getElementById('mechanismContent');
      const toggle = document.getElementById('mechanismToggle');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '▲';
        toggle.classList.add('expanded');
      } else {
        content.style.display = 'none';
        toggle.textContent = '▼';
        toggle.classList.remove('expanded');
      }
    }

    // 返回登录页面
    function backToLogin() {
      currentJson = null;
      currentGistId = null;
      currentToken = null;
      currentFileName = null;
      currentFileInfo = null;
      
      // 清除App ID显示
      document.getElementById('currentAppId').textContent = '-';
      
      showPage('loginPage');
      showLoginMsg('请输入应用凭据以访问配置管理控制台', 'info');
    }

    // 加载配置到界面
    function loadRedirectConfig() {
      if (!currentJson) return;
      
      const version = currentJson.version || '1';
      const isEnabled = currentJson.isRedirectEnabled || false;
      let redirectUrl = currentJson.redirectUrl;
      
      // 如果redirectUrl为null或空，设置默认值
      if (!redirectUrl || redirectUrl === null) {
        redirectUrl = 'https://example.com';
        currentJson.redirectUrl = redirectUrl;
      }
      
      // 更新界面元素
      document.getElementById('versionInput').value = parseInt(version);
      document.getElementById('redirectEnabled').checked = isEnabled;
      document.getElementById('redirectUrlInput').value = redirectUrl;
      
      // 清除验证信息
      const versionValidation = document.getElementById('versionValidation');
      const urlValidation = document.getElementById('urlValidation');
      versionValidation.style.display = 'none';
      urlValidation.style.display = 'none';
      
      // 更新状态文字和预览
      updateRedirectStatus();
      updateConfigPreview();
      
      // 自动验证加载的URL
      validateUrl();
    }

    // 更新版本信息
    function updateVersion() {
      const input = document.getElementById('versionInput');
      const validation = document.getElementById('versionValidation');
      let newVersion = parseInt(input.value);
      
      // 获取当前版本号
      const currentVersion = parseInt(currentJson.version) || 0;
      
      // 版本号验证
      if (!newVersion || newVersion < 1) {
        newVersion = Math.max(1, currentVersion);
        input.value = newVersion;
        validation.className = 'url-validation invalid';
        validation.innerHTML = '❌ 版本号必须是大于0的整数';
        validation.style.display = 'block';
      } else if (newVersion < currentVersion) {
        // 版本号不能递减
        input.value = currentVersion;
        validation.className = 'url-validation invalid';
        validation.innerHTML = `❌ 版本号只能递增，当前版本为 ${currentVersion}，请输入大于等于 ${currentVersion} 的版本号`;
        validation.style.display = 'block';
        return;
      } else if (newVersion === currentVersion) {
        // 版本号相同
        validation.className = 'url-validation info';
        validation.innerHTML = `ℹ️ 版本号保持不变：${newVersion}`;
        validation.style.display = 'block';
            } else {
        // 版本号递增
        validation.className = 'url-validation valid';
        validation.innerHTML = `✅ 版本号从 ${currentVersion} 升级到 ${newVersion}`;
        validation.style.display = 'block';
      }
      
      currentJson.version = String(newVersion);
      updateConfigPreview();
    }

    // 更新重定向启用状态
    function updateRedirectEnabled() {
      const isEnabled = document.getElementById('redirectEnabled').checked;
      currentJson.isRedirectEnabled = isEnabled;
      updateRedirectStatus();
      updateConfigPreview();
    }

    // 更新重定向URL
    function updateRedirectUrl() {
      let url = document.getElementById('redirectUrlInput').value.trim();
      const validation = document.getElementById('urlValidation');
      
      // URL不能为空
      if (!url) {
        validation.className = 'url-validation invalid';
        validation.innerHTML = '❌ 目标跳转地址不能为空，请输入有效的网址';
        validation.style.display = 'block';
        return;
      }
      
      // 自动添加 https:// 前缀（如果用户输入的是纯域名）
      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        // 检查是否看起来像域名（包含点号但不是文件路径）
        if (url.includes('.') && !url.startsWith('/') && !url.includes(' ')) {
          url = 'https://' + url;
          document.getElementById('redirectUrlInput').value = url;
        }
      }
      
      currentJson.redirectUrl = url;
      updateConfigPreview();
      // 隐藏验证状态，等待格式验证
      validation.style.display = 'none';
    }

    // 快速设置预设URL
    function setQuickUrl(url) {
      document.getElementById('redirectUrlInput').value = url;
      currentJson.redirectUrl = url;
      updateConfigPreview();
      validateUrl();
    }

    // 重置URL为默认地址
    function clearUrl() {
      const defaultUrl = 'https://example.com';
      document.getElementById('redirectUrlInput').value = defaultUrl;
      currentJson.redirectUrl = defaultUrl;
      updateConfigPreview();
      validateUrl();
      // 显示重置提示
      const validation = document.getElementById('urlValidation');
      validation.className = 'url-validation info';
      validation.innerHTML = '🔄 已重置为默认地址';
      validation.style.display = 'block';
    }

    // 验证URL格式
    function validateUrl() {
      const input = document.getElementById('redirectUrlInput');
      const url = input.value.trim();
      const validation = document.getElementById('urlValidation');
      
      if (!url) {
        validation.className = 'url-validation invalid';
        validation.innerHTML = '❌ 目标跳转地址不能为空，请输入有效的网址';
        validation.style.display = 'block';
        return false;
      }

      try {
        const urlObj = new URL(url);
        if (urlObj.protocol === 'http:' || urlObj.protocol === 'https:') {
          validation.className = 'url-validation valid';
          validation.innerHTML = '✅ URL格式正确';
          validation.style.display = 'block';
          return true;
        } else {
          validation.className = 'url-validation invalid';
          validation.innerHTML = '❌ 请使用 http:// 或 https:// 开头的网址';
          validation.style.display = 'block';
          return false;
        }
      } catch (e) {
        validation.className = 'url-validation invalid';
        validation.innerHTML = '❌ 无效的URL格式，请检查网址是否正确';
        validation.style.display = 'block';
        return false;
      }
    }

    // 测试URL是否可访问
    function testUrl() {
      const input = document.getElementById('redirectUrlInput');
      const url = input.value.trim();
      const validation = document.getElementById('urlValidation');
      const testBtn = document.getElementById('testBtn');
      
      if (!url) {
        validation.className = 'url-validation invalid';
        validation.innerHTML = '❌ 请先输入要测试的网址';
        validation.style.display = 'block';
        return;
      }

      try {
        new URL(url); // 先验证URL格式
      } catch (e) {
        validation.className = 'url-validation invalid';
        validation.innerHTML = '❌ 请输入有效的网址格式';
        validation.style.display = 'block';
        return;
      }

      // 显示测试中状态
      validation.className = 'url-validation testing';
      validation.innerHTML = '🔄 正在测试链接可访问性...';
      validation.style.display = 'block';
      testBtn.disabled = true;
      testBtn.innerHTML = '⏳';

      // 使用fetch测试链接（注意：由于CORS限制，可能无法访问所有网站）
      fetch(url, { 
        method: 'HEAD', 
        mode: 'no-cors',
        timeout: 5000 
      }).then(() => {
        validation.className = 'url-validation valid';
        validation.innerHTML = '✅ 链接测试成功，网站可正常访问';
      }).catch((error) => {
        // 对于no-cors模式，大多数情况下会进入catch，但这不代表链接无效
        validation.className = 'url-validation valid';
        validation.innerHTML = '⚠️ 由于跨域限制无法完全验证，但URL格式正确<br><small>建议手动点击验证：<a href="' + url + '" target="_blank" style="color:#1677ff;">打开链接测试</a></small>';
      }).finally(() => {
        testBtn.disabled = false;
        testBtn.innerHTML = '🔗';
      });
    }

    // 更新重定向状态文字
    function updateRedirectStatus() {
      const isEnabled = document.getElementById('redirectEnabled').checked;
      const statusElement = document.getElementById('redirectStatus');
      
      if (isEnabled) {
        statusElement.textContent = '已启用';
        statusElement.className = 'switch-status enabled';
      } else {
        statusElement.textContent = '已禁用';
        statusElement.className = 'switch-status disabled';
      }
    }

    // 更新配置预览
    function updateConfigPreview() {
      const version = currentJson.version || '1';
      const isEnabled = currentJson.isRedirectEnabled;
      const redirectUrl = currentJson.redirectUrl || 'https://example.com';
      
      // 更新版本显示
      document.getElementById('previewVersionText').textContent = `第 ${version} 版`;
      document.getElementById('previewVersionText').style.color = '#9333ea';
      
      // 更新重定向状态显示
      const enabledText = isEnabled ? '已开启' : '已关闭';
      document.getElementById('previewEnabledText').textContent = enabledText;
      document.getElementById('previewEnabledText').style.color = isEnabled ? '#10b981' : '#ef4444';
      
      // 更新跳转目标显示
      document.getElementById('previewUrlText').textContent = redirectUrl;
      document.getElementById('previewUrlText').style.color = '#1d4ed8';
    }

    // 保守的JSON注释清理（仅处理注释，不动其他字符）
    function removeJsonComments(jsonString) {
      console.log('清理前JSON:', jsonString);
      
      // 最保守的方法：使用正则表达式精确清理注释
      let cleanJson = jsonString;
      
      // 移除BOM标记
      cleanJson = cleanJson.replace(/^\uFEFF/, '');
      
      // 分行处理，逐行移除注释
      const lines = cleanJson.split('\n');
      const cleanedLines = lines.map(line => {
        // 查找 // 注释，但要避免在字符串内的 //
        let inString = false;
        let escapeNext = false;
        let result = '';
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (escapeNext) {
            result += char;
            escapeNext = false;
            continue;
          }
          
          if (char === '\\' && inString) {
            result += char;
            escapeNext = true;
            continue;
          }
          
          if (char === '"' && !escapeNext) {
            inString = !inString;
            result += char;
            continue;
          }
          
          // 如果不在字符串内，检查是否是注释开始
          if (!inString && char === '/' && i + 1 < line.length && line[i + 1] === '/') {
            // 找到注释，截断到这里
            break;
          }
          
          result += char;
        }
        
        return result.trimEnd(); // 移除行尾空白
      });
      
      // 重新连接行
      cleanJson = cleanedLines.join('\n');
      
      // 移除多行注释 /* */（简单版本，不处理字符串内的情况）
      cleanJson = cleanJson.replace(/\/\*[\s\S]*?\*\//g, '');
      
      // 移除空行
      cleanJson = cleanJson.replace(/^\s*[\r\n]/gm, '');
      
      const result = cleanJson.trim();
      console.log('清理后JSON:', result);
      
      return result;
    }

    // 解析 gistId 或 url
    function parseGistId(input) {
      if (!input) return '';
      if (/^[a-f0-9]{8,}$/i.test(input)) return input;
      const m = input.match(/gist\.github\.com\/(?:[^\/]+\/)?([a-f0-9]{8,})/i);
      return m ? m[1] : '';
    }

    // 连接到系统并加载配置
    async function connectToGist() {
      const gistInput = document.getElementById('gistId').value.trim();
      const token = document.getElementById('token').value.trim();
      const gistId = parseGistId(gistInput);
      
      if (!gistId) return showLoginMsg('请输入有效的应用标识符', 'error');
      if (!token) return showLoginMsg('请输入访问令牌以获得管理权限', 'warning');
      
      document.getElementById('connectBtn').disabled = true;
      showLoginMsg('正在验证身份并连接到APP应用...', 'info');
      
      try {
        // 构建请求头
        const headers = {
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'App-Config-Manager/1.0',
          'Authorization': `Bearer ${token}`
        };
        
        // 获取 Gist 信息
        const res = await fetch(`https://api.github.com/gists/${gistId}`, {
          method: 'GET',
          headers: headers,
          mode: 'cors'
        });
        
        if (!res.ok) {
          if (res.status === 404) {
            showLoginMsg('应用资源不存在或您无权访问', 'error');
          } else if (res.status === 403) {
            showLoginMsg('访问权限不足，请检查您的访问令牌权限', 'error');
          } else if (res.status === 401) {
            showLoginMsg('身份验证失败，请检查访问令牌是否正确', 'error');
          } else {
            showLoginMsg(`APP应用连接失败：${res.status} ${res.statusText}`, 'error');
          }
          return;
        }
        
        const data = await res.json();
        
        // 找到第一个 JSON 文件
        const fileEntry = Object.entries(data.files).find(([k, v]) => 
          v.language === 'JSON' || k.toLowerCase().endsWith('.json')
        );
        
        if (!fileEntry) {
          showLoginMsg('未找到配置文件，请确保应用中包含有效的配置数据', 'error');
          return;
        }
        
        const fileName = fileEntry[0];
        const fileInfo = fileEntry[1];
        
        showLoginMsg('正在加载应用配置数据...', 'info');
        
        // 获取文件内容
        let jsonText;
        if (fileInfo.content) {
          jsonText = fileInfo.content;
        } else {
          const rawRes = await fetch(fileInfo.raw_url, {
            method: 'GET',
            headers: headers,
            mode: 'cors'
          });
          
        if (!rawRes.ok) {
            showLoginMsg(`配置数据加载失败：${rawRes.status} ${rawRes.statusText}`, 'error');
          return;
          }
          
          jsonText = await rawRes.text();
        }
        
        // 解析配置数据
        try {
          // 首先尝试简单的注释清理
          let simpleCleanJson = jsonText
            .replace(/\/\/.*$/gm, '')  // 移除单行注释
            .replace(/\/\*[\s\S]*?\*\//g, '')  // 移除多行注释
            .replace(/^\uFEFF/, '')  // 移除BOM
            .trim();
          
          console.log('尝试简单清理:', simpleCleanJson);
          
          try {
            // 先尝试简单清理的结果
            currentJson = JSON.parse(simpleCleanJson);
            console.log('✅ 简单清理成功解析JSON');
          } catch (simpleError) {
            console.log('❌ 简单清理失败，尝试完整清理...');
            
            // 如果简单清理失败，使用完整的清理方法
            const cleanJsonText = removeJsonComments(jsonText);
            
            // 添加调试信息（开发模式下可见）
            console.log('原始JSON内容:', jsonText);
            console.log('清理后JSON内容:', cleanJsonText);
            console.log('字符长度对比:', { 
              original: jsonText.length, 
              cleaned: cleanJsonText.length,
              diff: jsonText.length - cleanJsonText.length 
            });
            
            // 调试：显示位置74附近的字符
            const problemPos = 74;
            const start = Math.max(0, problemPos - 10);
            const end = Math.min(cleanJsonText.length, problemPos + 10);
            console.log('位置74附近的字符:', {
              substring: cleanJsonText.substring(start, end),
              charCodes: Array.from(cleanJsonText.substring(start, end)).map((c, i) => ({
                pos: start + i,
                char: c,
                code: c.charCodeAt(0)
              }))
            });
            
            currentJson = JSON.parse(cleanJsonText);
          }
        } catch (e) {
          console.error('JSON解析失败详细信息:', {
            error: e.message,
            position: e.message.match(/position (\d+)/)?.[1],
            originalLength: jsonText.length,
            cleanedLength: removeJsonComments(jsonText).length
          });
          
          // 尝试提供更友好的错误提示
          let friendlyMessage = '配置数据格式错误';
          if (e.message.includes('control character')) {
            friendlyMessage = '配置数据包含不支持的特殊字符，请检查是否有隐藏字符或编码问题';
          } else if (e.message.includes('Unexpected token')) {
            friendlyMessage = '配置数据语法错误，请检查JSON格式是否正确';
          } else if (e.message.includes('Unexpected end')) {
            friendlyMessage = '配置数据不完整，请检查是否缺少闭合括号或引号';
          }
          
          showLoginMsg(`${friendlyMessage}：${e.message}`, 'error');
          return;
        }
        
        // 保存全局状态
        currentGistId = gistId;
        currentToken = token;
        currentFileName = fileName;
        currentFileInfo = fileInfo;
        
        // 保存文件信息（用于后续操作）
        
        // 验证配置格式并初始化缺失字段
        if (!currentJson.hasOwnProperty('version')) {
          currentJson.version = '1';
        }
        if (!currentJson.hasOwnProperty('isRedirectEnabled')) {
          currentJson.isRedirectEnabled = false;
        }
        if (!currentJson.hasOwnProperty('redirectUrl') || !currentJson.redirectUrl) {
          currentJson.redirectUrl = 'https://example.com';
        }
        
        // 加载配置到界面
        loadRedirectConfig();
        
        // 更新App ID显示
        const displayAppId = gistId.length > 8 ? gistId.substring(0, 8) + '...' : gistId;
        document.getElementById('currentAppId').textContent = displayAppId;
        
        // 切换到管理控制台
        showPage('editPage');
        showEditMsg('🎉 APP应用连接成功，配置数据已加载！', 'success');
        
      } catch (e) {
        console.error('连接APP应用时发生错误:', e);
        
        if (e.name === 'TypeError' && e.message.includes('fetch')) {
          showLoginMsg('网络连接失败，请检查网络连接和应用标识符', 'error');
        } else if (e.message.includes('CORS')) {
          showLoginMsg('网络请求被阻止，请稍后再试', 'error');
        } else {
          showLoginMsg(`APP应用连接异常：${e.message}`, 'error');
        }
      } finally {
        document.getElementById('connectBtn').disabled = false;
      }
    }

    // 保存配置
    async function saveToGist() {
      if (!currentGistId || !currentToken || !currentFileName || !currentJson) {
        showEditMsg('缺少必要信息，请重新连接到APP应用', 'error');
        return;
      }
      
      // 验证必填字段
      if (!currentJson.redirectUrl || currentJson.redirectUrl.trim() === '') {
        showEditMsg('❌ 目标跳转地址不能为空，请填写有效的网址', 'error');
        // 聚焦到URL输入框
        document.getElementById('redirectUrlInput').focus();
        return;
      }
      
      // 验证URL格式
      if (!validateUrl()) {
        showEditMsg('❌ 请修正目标跳转地址的格式错误后再保存', 'error');
        return;
      }
      
      document.getElementById('saveBtn').disabled = true;
      showEditMsg('正在保存配置到APP应用...', 'info');
      
      try {
        const headers = {
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'App-Config-Manager/1.0',
          'Authorization': `Bearer ${currentToken}`,
          'Content-Type': 'application/json'
        };
        
        const requestBody = {
          files: {
            [currentFileName]: {
              content: JSON.stringify(currentJson, null, 2)
            }
          }
        };
        
        const res = await fetch(`https://api.github.com/gists/${currentGistId}`, {
          method: 'PATCH',
          headers: headers,
          mode: 'cors',
          body: JSON.stringify(requestBody)
        });
        
        if (!res.ok) {
          if (res.status === 404) {
            showEditMsg('应用资源不存在或已被删除', 'error');
          } else if (res.status === 403) {
            showEditMsg('没有编辑权限，请检查您的访问令牌权限', 'error');
          } else if (res.status === 401) {
            showEditMsg('身份验证失败，访问令牌可能已过期', 'error');
          } else {
            showEditMsg(`保存失败：${res.status} ${res.statusText}`, 'error');
          }
          return;
        }
        
        const data = await res.json();
        showEditMsg('✨ 配置保存成功！数据已同步到APP应用', 'success');
        
        // 更新文件信息
        currentFileInfo = data.files[currentFileName];
        
      } catch (e) {
        console.error('保存配置时发生错误:', e);
        showEditMsg(`保存失败：${e.message}`, 'error');
      } finally {
        document.getElementById('saveBtn').disabled = false;
      }
    }

    // 消息显示系统
    function showLoginMsg(msg, type = 'info') {
      const msgElement = document.getElementById('loginMsg');
      msgElement.textContent = msg;
      msgElement.className = `msg ${type}`;
      msgElement.style.display = 'block';
      
      // 自动隐藏成功消息
      if (type === 'success') {
        setTimeout(() => {
          msgElement.style.display = 'none';
        }, 3000);
      }
    }

    function showEditMsg(msg, type = 'info') {
      const msgElement = document.getElementById('editMsg');
      msgElement.textContent = msg;
      msgElement.className = `msg ${type}`;
      msgElement.style.display = 'block';
      
      // 自动隐藏成功消息
      if (type === 'success') {
        setTimeout(() => {
          msgElement.style.display = 'none';
        }, 5000);
      }
    }
  </script>
</body>
</html> 