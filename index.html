<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gist JSON é…ç½®ç¼–è¾‘å™¨</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1em; background: #f7f7f7; }
    .container { max-width: 600px; margin: 0 auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 2em; }
    .field { margin-bottom: 1em; }
    label { display: block; margin-bottom: 0.3em; font-weight: bold; }
    input, select, button { width: 100%; padding: 0.5em; font-size: 1em; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background: #1677ff; color: #fff; border: none; cursor: pointer; margin-top: 1em; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button.success { background: #52c41a; }
    button.danger { background: #ff4d4f; }
    button.secondary { background: #8c8c8c; }
    .switch { width: 40px; height: 20px; }
    .msg { margin: 1em 0; padding: 0.8em; border-radius: 6px; font-weight: 500; }
    .msg.success { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
    .msg.error { background: #fff2f0; color: #ff4d4f; border: 1px solid #ffccc7; }
    .msg.info { background: #f0f9ff; color: #1677ff; border: 1px solid #91d5ff; }
    .msg.warning { background: #fffbe6; color: #d46b08; border: 1px solid #ffe58f; }
    .json-group { border-left: 2px solid #eee; margin-left: 0.5em; padding-left: 0.5em; }
    .page { display: none; }
    .page.active { display: block; }
    .header { text-align: center; margin-bottom: 2em; }
    .header h1 { margin: 0; color: #262626; }
    .header p { margin: 0.5em 0 0 0; color: #8c8c8c; }
    .button-group { display: flex; gap: 0.5em; margin-top: 1em; }
    .button-group button { margin: 0; flex: 1; }
    .config-info { background: #e6f7ff; border-radius: 6px; padding: 1em; margin-bottom: 1em; }
    .config-info h3 { margin: 0 0 0.5em 0; color: #1677ff; }
    .config-info p { margin: 0; font-size: 0.9em; color: #595959; }
  </style>
</head>
<body>
  <div class="container">
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage" class="page active">
      <div class="header">
        <h1>Gist JSON é…ç½®ç¼–è¾‘å™¨</h1>
        <p>åœ¨çº¿ç¼–è¾‘å’ŒåŒæ­¥ GitHub Gist ä¸­çš„ JSON é…ç½®æ–‡ä»¶</p>
      </div>
      
      <div class="field">
        <label for="gistId">Gist é“¾æ¥æˆ– ID</label>
        <input id="gistId" placeholder="å¦‚ï¼ša1b2c3d4e5... æˆ– https://gist.github.com/xxx/yyy" autocomplete="off">
      </div>
      
      <div class="field">
        <label for="token">GitHub Token</label>
        <input id="token" type="password" placeholder="è®¿é—®ç§æœ‰ Gist æˆ–ç¼–è¾‘é…ç½®æ—¶å¿…éœ€" autocomplete="off">
      </div>
      
      <button onclick="connectToGist()" id="connectBtn">è¿æ¥åˆ° Gist</button>
      
      <div id="loginMsg" class="msg info" style="display:none;"></div>
    </div>

    <!-- é…ç½®ç¼–è¾‘é¡µé¢ -->
    <div id="editPage" class="page">
      <div class="config-info">
        <h3 id="configTitle">é…ç½®æ–‡ä»¶ä¿¡æ¯</h3>
        <p id="configDesc">æ–‡ä»¶ï¼š<span id="fileName"></span> | é…ç½®é¡¹ï¼š<span id="configCount"></span></p>
      </div>
      
      <form id="jsonForm" onsubmit="event.preventDefault();"></form>
      
      <div class="button-group">
        <button onclick="saveToGist()" id="saveBtn" class="success">ä¿å­˜åˆ° Gist</button>
        <button onclick="exportJson()" class="secondary">å¯¼å‡ºæœ¬åœ°</button>
        <button onclick="backToLogin()" class="danger">è¿”å›</button>
      </div>
      
      <div id="editMsg" class="msg info" style="display:none;"></div>
    </div>
  </div>
  <script>
    // å…¨å±€çŠ¶æ€
    let currentJson = null;
    let currentGistId = null;
    let currentToken = null;
    let currentFileName = null;
    let currentFileInfo = null;

    // é¡µé¢åˆ‡æ¢
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
    }

    // è¿”å›ç™»å½•é¡µé¢
    function backToLogin() {
      currentJson = null;
      currentGistId = null;
      currentToken = null;
      currentFileName = null;
      currentFileInfo = null;
      showPage('loginPage');
      showLoginMsg('è¯·è¾“å…¥ Gist ä¿¡æ¯è¿›è¡Œè¿æ¥', 'info');
    }

    // é€’å½’æ¸²æŸ“ JSON ä¸ºè¡¨å•
    function renderJsonForm(json, container, path = []) {
      container.innerHTML = '';
      for (const key in json) {
        const value = json[key];
        const fieldPath = path.concat(key);
        const fieldId = 'field_' + fieldPath.join('_');
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'field';
        const label = document.createElement('label');
        label.textContent = key;
        label.htmlFor = fieldId;
        fieldDiv.appendChild(label);
        if (typeof value === 'boolean') {
          // Switch
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.id = fieldId;
          input.checked = value;
          input.onchange = () => setValueByPath(currentJson, fieldPath, input.checked);
          fieldDiv.appendChild(input);
        } else if (typeof value === 'number' || typeof value === 'string') {
          // æ–‡æœ¬è¾“å…¥
          const input = document.createElement('input');
          input.type = typeof value === 'number' ? 'number' : 'text';
          input.id = fieldId;
          input.value = value;
          input.oninput = () => setValueByPath(currentJson, fieldPath, input.type === 'number' ? Number(input.value) : input.value);
          fieldDiv.appendChild(input);
        } else if (Array.isArray(value)) {
          // æ•°ç»„é€’å½’
          const group = document.createElement('div');
          group.className = 'json-group';
          value.forEach((item, idx) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'field';
            const itemLabel = document.createElement('label');
            itemLabel.textContent = key + '[' + idx + ']';
            itemDiv.appendChild(itemLabel);
            if (typeof item === 'object' && item !== null) {
              renderJsonForm(item, itemDiv, fieldPath.concat(idx));
            } else {
              const input = document.createElement('input');
              input.type = typeof item === 'number' ? 'number' : 'text';
              input.value = item;
              input.oninput = () => setValueByPath(currentJson, fieldPath.concat(idx), input.type === 'number' ? Number(input.value) : input.value);
              itemDiv.appendChild(input);
            }
            group.appendChild(itemDiv);
          });
          fieldDiv.appendChild(group);
        } else if (typeof value === 'object' && value !== null) {
          // åµŒå¥—å¯¹è±¡é€’å½’
          const group = document.createElement('div');
          group.className = 'json-group';
          renderJsonForm(value, group, fieldPath);
          fieldDiv.appendChild(group);
        } else {
          // å…¶ä»–ç±»å‹åªè¯»
          const span = document.createElement('span');
          span.textContent = String(value);
          fieldDiv.appendChild(span);
        }
        container.appendChild(fieldDiv);
      }
    }

    // æ ¹æ®è·¯å¾„è®¾ç½®å€¼
    function setValueByPath(obj, path, value) {
      let o = obj;
      for (let i = 0; i < path.length - 1; i++) {
        o = o[path[i]];
      }
      o[path[path.length - 1]] = value;
    }

    // å¯¼å‡º JSON æ–‡ä»¶åˆ°æœ¬åœ°
    function exportJson() {
      if (!currentJson) {
        showEditMsg('æ²¡æœ‰å¯å¯¼å‡ºçš„é…ç½®æ•°æ®', 'warning');
        return;
      }
      
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentJson, null, 2));
      const dlAnchor = document.createElement('a');
      dlAnchor.setAttribute("href", dataStr);
      dlAnchor.setAttribute("download", currentFileName || "config.json");
      document.body.appendChild(dlAnchor);
      dlAnchor.click();
      document.body.removeChild(dlAnchor);
      showEditMsg('ğŸ“¥ é…ç½®å·²å¯¼å‡ºåˆ°æœ¬åœ°', 'success');
    }

    // è§£æ gistId æˆ– url
    function parseGistId(input) {
      if (!input) return '';
      if (/^[a-f0-9]{8,}$/i.test(input)) return input;
      const m = input.match(/gist\.github\.com\/(?:[^\/]+\/)?([a-f0-9]{8,})/i);
      return m ? m[1] : '';
    }

    // è¿æ¥åˆ° Gist å¹¶åŠ è½½é…ç½®
    async function connectToGist() {
      const gistInput = document.getElementById('gistId').value.trim();
      const token = document.getElementById('token').value.trim();
      const gistId = parseGistId(gistInput);
      
      if (!gistId) return showLoginMsg('è¯·è¾“å…¥æœ‰æ•ˆçš„ Gist é“¾æ¥æˆ– ID', 'error');
      if (!token) return showLoginMsg('è¯·è¾“å…¥ GitHub Token ä»¥è·å¾—ç¼–è¾‘æƒé™', 'warning');
      
      document.getElementById('connectBtn').disabled = true;
      showLoginMsg('æ­£åœ¨è¿æ¥åˆ° Gist...', 'info');
      
      try {
        // æ„å»ºè¯·æ±‚å¤´
        const headers = {
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'Gist-JSON-Editor/1.0',
          'Authorization': `Bearer ${token}`
        };
        
        // è·å– Gist ä¿¡æ¯
        const res = await fetch(`https://api.github.com/gists/${gistId}`, {
          method: 'GET',
          headers: headers,
          mode: 'cors'
        });
        
        if (!res.ok) {
          if (res.status === 404) {
            showLoginMsg('Gist ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®', 'error');
          } else if (res.status === 403) {
            showLoginMsg('è®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥ Token æƒé™', 'error');
          } else if (res.status === 401) {
            showLoginMsg('è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®', 'error');
          } else {
            showLoginMsg(`è¿æ¥å¤±è´¥ï¼š${res.status} ${res.statusText}`, 'error');
          }
          return;
        }
        
        const data = await res.json();
        
        // æ‰¾åˆ°ç¬¬ä¸€ä¸ª JSON æ–‡ä»¶
        const fileEntry = Object.entries(data.files).find(([k, v]) => 
          v.language === 'JSON' || k.toLowerCase().endsWith('.json')
        );
        
        if (!fileEntry) {
          showLoginMsg('æœªæ‰¾åˆ° JSON æ–‡ä»¶ï¼Œè¯·ç¡®ä¿ Gist ä¸­åŒ…å« .json æ–‡ä»¶', 'error');
          return;
        }
        
        const fileName = fileEntry[0];
        const fileInfo = fileEntry[1];
        
        showLoginMsg(`æ‰¾åˆ°æ–‡ä»¶ï¼š${fileName}ï¼Œæ­£åœ¨åŠ è½½å†…å®¹...`, 'info');
        
        // è·å–æ–‡ä»¶å†…å®¹
        let jsonText;
        if (fileInfo.content) {
          jsonText = fileInfo.content;
        } else {
          const rawRes = await fetch(fileInfo.raw_url, {
            method: 'GET',
            headers: headers,
            mode: 'cors'
          });
          
          if (!rawRes.ok) {
            showLoginMsg(`æ–‡ä»¶åŠ è½½å¤±è´¥ï¼š${rawRes.status} ${rawRes.statusText}`, 'error');
            return;
          }
          
          jsonText = await rawRes.text();
        }
        
        // è§£æ JSON
        try {
          currentJson = JSON.parse(jsonText);
        } catch (e) {
          showLoginMsg(`JSON è§£æå¤±è´¥ï¼š${e.message}`, 'error');
          return;
        }
        
        // ä¿å­˜å…¨å±€çŠ¶æ€
        currentGistId = gistId;
        currentToken = token;
        currentFileName = fileName;
        currentFileInfo = fileInfo;
        
        // æ›´æ–°é¡µé¢ä¿¡æ¯
        document.getElementById('fileName').textContent = fileName;
        document.getElementById('configCount').textContent = Object.keys(currentJson).length;
        
        // æ¸²æŸ“è¡¨å•
        renderJsonForm(currentJson, document.getElementById('jsonForm'));
        
        // åˆ‡æ¢åˆ°ç¼–è¾‘é¡µé¢
        showPage('editPage');
        showEditMsg(`æˆåŠŸè¿æ¥ï¼å…±åŠ è½½ ${Object.keys(currentJson).length} ä¸ªé…ç½®é¡¹`, 'success');
        
      } catch (e) {
        console.error('è¿æ¥ Gist æ—¶å‘ç”Ÿé”™è¯¯:', e);
        
        if (e.name === 'TypeError' && e.message.includes('fetch')) {
          showLoginMsg('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ Gist ID', 'error');
        } else if (e.message.includes('CORS')) {
          showLoginMsg('è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢ï¼Œè¯·ç¨åå†è¯•', 'error');
        } else {
          showLoginMsg(`ç½‘ç»œå¼‚å¸¸ï¼š${e.message}`, 'error');
        }
      } finally {
        document.getElementById('connectBtn').disabled = false;
      }
    }

    // ä¿å­˜åˆ° Gist
    async function saveToGist() {
      if (!currentGistId || !currentToken || !currentFileName || !currentJson) {
        showEditMsg('ç¼ºå°‘å¿…è¦ä¿¡æ¯ï¼Œè¯·é‡æ–°è¿æ¥åˆ° Gist', 'error');
        return;
      }
      
      document.getElementById('saveBtn').disabled = true;
      showEditMsg('æ­£åœ¨ä¿å­˜åˆ° Gist...', 'info');
      
      try {
        const headers = {
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'Gist-JSON-Editor/1.0',
          'Authorization': `Bearer ${currentToken}`,
          'Content-Type': 'application/json'
        };
        
        const requestBody = {
          files: {
            [currentFileName]: {
              content: JSON.stringify(currentJson, null, 2)
            }
          }
        };
        
        const res = await fetch(`https://api.github.com/gists/${currentGistId}`, {
          method: 'PATCH',
          headers: headers,
          mode: 'cors',
          body: JSON.stringify(requestBody)
        });
        
        if (!res.ok) {
          if (res.status === 404) {
            showEditMsg('Gist ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤', 'error');
          } else if (res.status === 403) {
            showEditMsg('æ²¡æœ‰ç¼–è¾‘æƒé™ï¼Œè¯·æ£€æŸ¥ Token æƒé™', 'error');
          } else if (res.status === 401) {
            showEditMsg('è®¤è¯å¤±è´¥ï¼ŒToken å¯èƒ½å·²è¿‡æœŸ', 'error');
          } else {
            showEditMsg(`ä¿å­˜å¤±è´¥ï¼š${res.status} ${res.statusText}`, 'error');
          }
          return;
        }
        
        const data = await res.json();
        showEditMsg('âœ¨ ä¿å­˜æˆåŠŸï¼é…ç½®å·²åŒæ­¥åˆ° GitHub Gist', 'success');
        
        // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
        currentFileInfo = data.files[currentFileName];
        
      } catch (e) {
        console.error('ä¿å­˜åˆ° Gist æ—¶å‘ç”Ÿé”™è¯¯:', e);
        showEditMsg(`ä¿å­˜å¤±è´¥ï¼š${e.message}`, 'error');
      } finally {
        document.getElementById('saveBtn').disabled = false;
      }
    }

    // æ¶ˆæ¯æ˜¾ç¤ºç³»ç»Ÿ
    function showLoginMsg(msg, type = 'info') {
      const msgElement = document.getElementById('loginMsg');
      msgElement.textContent = msg;
      msgElement.className = `msg ${type}`;
      msgElement.style.display = 'block';
      
      // è‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
      if (type === 'success') {
        setTimeout(() => {
          msgElement.style.display = 'none';
        }, 3000);
      }
    }

    function showEditMsg(msg, type = 'info') {
      const msgElement = document.getElementById('editMsg');
      msgElement.textContent = msg;
      msgElement.className = `msg ${type}`;
      msgElement.style.display = 'block';
      
      // è‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
      if (type === 'success') {
        setTimeout(() => {
          msgElement.style.display = 'none';
        }, 5000);
      }
    }
  </script>
</body>
</html> 