<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>应用配置管理平台</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚙️</text></svg>">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <!-- 顶部通知 -->
  <div id="topNotification" class="top-notification"></div>
  
  <!-- 登录页面 -->
  <div id="loginPage" class="page active">
    <div class="login-container">
      <div class="login-card">
        <div class="login-main">
          <div class="system-logo">⚙️</div>
          <h1 class="system-title">应用配置管理平台</h1>
          <p class="system-desc">集中管理和配置您的应用参数，安全、高效、可靠</p>
          
          <div class="security-notice">
            <span class="icon">🔒</span>
            <strong>安全提示：</strong>请确保您的访问凭据安全，平台采用端到端加密保护您的数据
          </div>
          
          <div class="field">
            <label for="gistId">App ID</label>
            <input id="gistId" placeholder="请输入您的应用标识符" autocomplete="off">
          </div>
          
          <div class="field">
            <label for="token">访问令牌</label>
            <input id="token" type="password" placeholder="请输入您的访问令牌" autocomplete="off">
          </div>
          
          <button onclick="connectToGist()" id="connectBtn" class="login-btn">连接到APP应用</button>
          <button onclick="registerNewGist()" id="registerBtn" class="login-btn" style="margin-top:0.6em;background:linear-gradient(135deg,#10b981 0%, #059669 100%);">注册新APP应用</button>
          <button onclick="openGistListModal()" id="listGistsBtn" class="login-btn" style="margin-top:0.6em;background:linear-gradient(135deg,#6366f1 0%, #7c3aed 100%);">查看我的Gists</button>
          
          <div id="loginMsg" class="msg info" style="display:none;"></div>
        </div>
        
        <div class="footer-info">
          <p class="version">应用配置管理平台 v2.1.0</p>
          <p class="copyright">© 2024 Enterprise Config Solutions</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 管理页面 -->
  <div id="editPage" class="page">
    <div class="admin-container">
      <div class="admin-header">
        <div class="admin-title">
          <h2>🎛️ 应用配置控制台</h2>
          <div class="admin-user">
            <span>🟢 连接状态：<span style="color: #10b981; font-weight: 600;">已连接</span></span>
            <span style="margin-left: 2em;">📊 App ID：<span id="currentAppId" style="color: #6b7280; font-weight: 600; font-family: monospace;">-</span></span>
          </div>
        </div>
      </div>
      
      <div class="admin-content">
        <div class="config-panel">
          <div class="panel-title">🌐 页面重定向管理</div>
          
          <div class="field">
            <label class="switch-label">重定向功能状态</label>
            <div class="switch-container">
              <label class="switch">
                <input type="checkbox" id="redirectEnabled" onchange="updateRedirectEnabled()">
                <span class="slider"></span>
              </label>
              <span id="redirectStatus" class="switch-status enabled">已启用</span>
            </div>
            <small style="color: #6b7280; margin-top: 0.5em; display: block;">
              开启后，用户访问页面将自动跳转到指定地址
            </small>
          </div>
    
          <div class="field" id="urlConfigField">
            <label for="redirectUrlInput">目标跳转地址 <span style="color: #ef4444;">*</span></label>
            <div class="url-input-container">
              <input type="url" id="redirectUrlInput" placeholder="输入网址，如：example.com" oninput="updateRedirectUrl()" onblur="validateUrl()" required>
              <button type="button" class="clear-url-btn" onclick="clearUrl()" id="clearBtn" title="重置为默认地址">🔄</button>
              <button type="button" class="test-url-btn" onclick="testUrl()" id="testBtn" title="测试链接">🔗</button>
            </div>
            <div id="urlValidation" class="url-validation" style="display: none;"></div>
            
            <div class="quick-urls">
              <label style="font-size: 0.9em; color: #6b7280; margin-bottom: 0.8em; display: block; font-weight: 600;">⚡ 快速配置模板：</label>
              <div class="url-buttons">
                <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://flutter.dev/')">Flutter</button>
                <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://github.com/')">GitHub</button>
                <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://docs.flutter.dev/')">Flutter文档</button>
                <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://pub.dev/')">Pub.dev</button>
                <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://developer.android.com/')">Android</button>
                <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://developer.apple.com/')">iOS</button>
                <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://stackoverflow.com/')">Stack Overflow</button>
                <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://npmjs.com/')">npm</button>
                <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://www.google.com/')">Google</button>
                <button type="button" class="quick-url-btn" onclick="setQuickUrl('https://www.bilibili.com/')">哔哩哔哩</button>
              </div>
            </div>
            
            <small style="color: #6b7280; margin-top: 1em; display: block;">
              💡 提示：此字段为必填项，支持任何有效的网址，系统会自动验证链接的可访问性
            </small>
          </div>
        </div>

        <div class="config-panel" id="accessPanel">
          <div class="panel-title">🛡️ 访问控制</div>
          <div class="field">
            <label for="allowedCountriesInput">允许国家（ISO 2位，逗号分隔）</label>
            <div class="url-input-container">
              <input id="allowedCountriesInput" placeholder="例如：BR, US" oninput="updateAllowedCountries()">
              <button type="button" class="clear-url-btn" onclick="clearAllowedCountries()" title="清空">🧹</button>
              <button type="button" class="test-url-btn" onclick="addCountryCode('BR')" title="添加巴西">🇧🇷</button>
            </div>
            <div id="accessValidation" class="url-validation" style="display: none;"></div>
            <small style="color: #6b7280; margin-top: 0.5em; display: block;">
              留空表示不限制。国家码使用 ISO 3166-1 Alpha-2（
              <a href="https://zh.wikipedia.org/wiki/ISO_3166-1" target="_blank" rel="noopener" style="color:#1677ff;">中文说明</a>
              或
              <a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2" target="_blank" rel="noopener" style="color:#1677ff;">英文国家码列表</a>
              ）。
            </small>

            <div class="quick-urls" style="margin-top: 0.75em;">
              <label style="font-size: 0.9em; color: #6b7280; margin-bottom: 0.6em; display: block; font-weight: 600;">⚡ 常用示例：</label>
              <div class="url-buttons">
                <button type="button" class="quick-url-btn" onclick="addCountryCode('US')">🇺🇸 United States (US)</button>
                <button type="button" class="quick-url-btn" onclick="addCountryCode('CN')">🇨🇳 China (CN)</button>
                <button type="button" class="quick-url-btn" onclick="addCountryCode('JP')">🇯🇵 Japan (JP)</button>
                <button type="button" class="quick-url-btn" onclick="addCountryCode('DE')">🇩🇪 Germany (DE)</button>
                <button type="button" class="quick-url-btn" onclick="addCountryCode('GB')">🇬🇧 United Kingdom (GB)</button>
                <button type="button" class="quick-url-btn" onclick="addCountryCode('FR')">🇫🇷 France (FR)</button>
                <button type="button" class="quick-url-btn" onclick="addCountryCode('CA')">🇨🇦 Canada (CA)</button>
                <button type="button" class="quick-url-btn" onclick="addCountryCode('AU')">🇦🇺 Australia (AU)</button>
                <button type="button" class="quick-url-btn" onclick="addCountryCode('IN')">🇮🇳 India (IN)</button>
                <button type="button" class="quick-url-btn" onclick="addCountryCode('BR')">🇧🇷 Brazil (BR)</button>
              </div>
            </div>
          </div>
        </div>

        <div class="config-panel" id="extraPanel">
          <div class="panel-title">🧩 扩展字段</div>
          <div class="field">
            <small style="color:#6b7280; display:block; margin-bottom:0.6em;">用于存放额外键值对，保存时写入配置的 <code>extra</code> 字段。</small>
            <div id="extraList" class="kv-list"></div>
            <div class="kv-actions" style="margin-top:0.6em;">
              <button type="button" class="admin-btn btn-primary" onclick="addExtraField()">➕ 添加字段</button>
            </div>
            <div class="export-actions" style="margin-top:0.6em;">
              <button type="button" class="admin-btn btn-secondary" onclick="generateAndCopyExtraJson()">📄 生成并复制 JSON</button>
            </div>
            <pre id="extraExportPreview" class="config-json" style="margin-top:0.6em;"></pre>
            <div id="extraExportValidation" class="url-validation" style="display:none;"></div>
          </div>
        </div>

        <div class="config-panel" id="encryptionPanel">
          <div class="panel-title">🔐 加密设置</div>
          <div class="field">
            <label class="switch-label">启用加密保存</label>
            <div class="switch-container">
              <label class="switch">
                <input type="checkbox" id="encryptionEnabled" onchange="toggleEncryptionEnabled()">
                <span class="slider"></span>
              </label>
              <span id="encryptionStatus" class="switch-status disabled">未启用</span>
            </div>
            <small style="color: #6b7280; margin-top: 0.5em; display: block;">启用后，配置将以加密形式写入 Gist，需口令解密。</small>
          </div>

          <div class="field" id="encryptionMethodField" style="display:none;">
            <label for="encryptionMethod">加密方式</label>
            <select id="encryptionMethod" onchange="updateEncryptionMethod()">
              <option value="AES-GCM">AES-GCM（PBKDF2 口令派生）</option>
            </select>
          </div>

          <div class="field" id="encryptionPassphraseField" style="display:none;">
            <label for="encryptionPassphrase">加密口令 <span style="color: #ef4444;">*</span></label>
            <div class="url-input-container">
              <input type="password" id="encryptionPassphrase" placeholder="请输入用于加密的口令" oninput="updateEncryptionPassphrase()">
              <button type="button" class="test-url-btn" onclick="togglePassphraseVisibility()" title="显示/隐藏">👁️</button>
            </div>
            <div id="encryptionValidation" class="url-validation" style="display: none;"></div>
            <small style="color: #6b7280; margin-top: 0.5em; display: block;">口令不保存于Gist，请妥善保管。</small>
          </div>
        </div>

        <div class="config-mechanism version-mechanism">
          <div class="mechanism-header" onclick="toggleVersionMechanism()">
            <h4>⚙️ 高级设置：版本管理</h4>
            <span id="versionToggle" class="mechanism-toggle">▼</span>
          </div>
          <div id="versionContent" class="mechanism-content" style="display: none;">
            <div style="background: #f1f5f9; padding: 0.8em; border-radius: 8px; margin-bottom: 1em; border-left: 3px solid #94a3b8; font-size: 0.9em; color: #64748b;">
              <strong>💡 开发者信息：</strong> 此区域显示应用版本号管理详情，主要用于技术调试和配置追踪。
            </div>
            <div class="field">
              <label for="versionInput">应用版本号</label>
              <input type="number" id="versionInput" placeholder="例如：1" min="1" readonly disabled style="背景: #f8fafc; color: #6b7280; cursor: not-allowed;">
              <div id="versionValidation" class="url-validation" style="display: block;">
                <span class="url-validation info">🤖 自动管理</span>
              </div>
              <small style="color: #6b7280; margin-top: 0.5em; display: block;">
                系统自动维护版本号，配置变更时递增。普通用户无需关注此功能。
              </small>
            </div>
          </div>
        </div>

        <div class="config-preview">
          <h4>📋 配置概览</h4>
          <div class="config-summary">
            <div class="summary-item">
              <span class="summary-label">📦 应用版本：</span>
              <span id="previewVersionText" class="summary-value" style="color: #9333ea;">第 1 版</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">🔄 重定向功能：</span>
              <span id="previewEnabledText" class="summary-value" style="color: #ef4444;">已关闭</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">🎯 跳转目标：</span>
              <span id="previewUrlText" class="summary-value" style="color: #1d4ed8;">https://example.com</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">🛡️ 访问控制：</span>
              <span id="previewAccessText" class="summary-value" style="color: #6b7280;">不限制</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">🔐 加密状态：</span>
              <span id="previewEncryptionText" class="summary-value" style="color: #6b7280;">未启用</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">🧩 扩展字段：</span>
              <span id="previewExtraText" class="summary-value" style="color: #6b7280;">无</span>
            </div>
          </div>
        </div>

        <div class="config-mechanism">
          <div class="mechanism-header" onclick="toggleConfigMechanism()">
            <h4>📖 配置读取机制</h4>
            <span id="mechanismToggle" class="mechanism-toggle">▼</span>
          </div>
          <div id="mechanismContent" class="mechanism-content" style="display: none;">
            <div class="mechanism-section">
              <h5>🔄 读取时机</h5>
              <div class="mechanism-items">
                <div class="mechanism-item">
                  <span class="item-label">应用启动:</span>
                  <span class="item-value">立即检查</span>
                </div>
                <div class="mechanism-item">
                  <span class="item-label">恢复前台:</span>
                  <span class="item-value">立即检查</span>
                </div>
                <div class="mechanism-item">
                  <span class="item-label">定时检查:</span>
                  <span class="item-value">前台2分钟间隔</span>
                </div>
              </div>
            </div>

            <div class="mechanism-section">
              <h5>🔍 版本号比较机制</h5>
              <div class="mechanism-items">
                <div class="mechanism-item">
                  <span class="item-label">获取本地版本号:</span>
                  <span class="item-value">从缓存读取</span>
                </div>
                <div class="mechanism-item">
                  <span class="item-label">轻量级检查远程版本:</span>
                  <span class="item-value">使用ETag优化</span>
                </div>
                <div class="mechanism-item">
                  <span class="item-label">版本号对比:</span>
                  <span class="item-value">不同则触发更新</span>
                </div>
                <div class="mechanism-item">
                  <span class="item-label">完整配置下载:</span>
                  <span class="item-value">仅在版本变化时</span>
                </div>
              </div>
            </div>

            <div class="mechanism-section">
              <h5>📊 读取流程</h5>
              <div class="flow-diagram">
                <div class="flow-step">本地版本 vs 远程版本</div>
                <div class="flow-arrow">↓</div>
                <div class="flow-branch">
                  <div class="flow-path">
                    <span class="flow-condition">版本相同</span>
                    <span class="flow-arrow-right">→</span>
                    <span class="flow-result">使用缓存</span>
                  </div>
                </div>
                <div class="flow-arrow">↓</div>
                <div class="flow-branch">
                  <div class="flow-path">
                    <span class="flow-condition">版本不同</span>
                    <span class="flow-arrow-right">→</span>
                    <span class="flow-result">下载新配置</span>
                  </div>
                </div>
                <div class="flow-arrow">↓</div>
                <div class="flow-branch">
                  <div class="flow-path">
                    <span class="flow-condition">网络失败</span>
                    <span class="flow-arrow-right">→</span>
                    <span class="flow-result">使用缓存/默认</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button onclick="saveToGist()" id="saveBtn" class="admin-btn btn-success">💾 保存配置</button>
          <button onclick="backToLogin()" class="admin-btn btn-danger">🚪 退出APP应用</button>
        </div>
        
        <div id="editMsg" class="msg info" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- 拆分后的脚本按逻辑层次引入，保持行为不变 -->
  <script src="assets/js/core/state.js"></script>
  <script src="assets/js/core/utils.js"></script>
  <script src="assets/js/features/validation.js"></script>
  <script src="assets/js/features/config.js"></script>
  <script src="assets/js/features/access.js"></script>
  <script src="assets/js/features/encryption.js"></script>
  <script src="assets/js/features/extra.js"></script>
  <script src="assets/js/ui/messages.js"></script>
  <script src="assets/js/ui/view.js"></script>
  <script src="assets/js/services/gist.js"></script>
  <script src="assets/js/app.js"></script>
  
  <!-- 自定义解密口令弹窗（与整体风格一致） -->
  <div id="passphraseModal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <div class="modal-header">
        <h3>🔐 请输入解密口令</h3>
      </div>
      <div class="modal-body">
        <p class="modal-desc">检测到配置已加密，请输入口令以继续加载管理界面。</p>
        <div class="field">
          <label for="passphraseModalInput">解密口令</label>
          <input type="password" id="passphraseModalInput" placeholder="请输入用于解密的口令">
        </div>
        <div id="passphraseModalValidation" class="url-validation" style="display:none;"></div>
      </div>
      <div class="modal-actions">
        <button type="button" class="admin-btn btn-secondary" onclick="cancelPassphraseModal()">取消</button>
        <button type="button" class="admin-btn btn-primary" onclick="confirmPassphraseModal()">确定</button>
      </div>
    </div>
  </div>

  <!-- 统一风格的删除确认弹窗 -->
  <div id="confirmModal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <div class="modal-header">
        <h3>⚠️ 确认删除</h3>
      </div>
      <div class="modal-body">
        <p class="modal-desc">确定要删除此扩展字段吗？该操作不可撤销。</p>
        <div class="field">
          <label>键</label>
          <div id="confirmDeleteKey" class="key-preview"></div>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="admin-btn btn-secondary" onclick="confirmDeleteModalCancel()">取消</button>
        <button type="button" class="admin-btn btn-danger" onclick="confirmDeleteModalOk()">删除</button>
      </div>
    </div>
  </div>

  <!-- 注册成功弹窗（统一风格） -->
  <div id="registerSuccessModal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <div class="modal-header">
        <h3>🎉 注册成功</h3>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>APP ID</label>
          <div id="registeredGistIdModal" class="key-preview" style="font-family: monospace;"></div>
        </div>
        <div class="field">
          <label>配置名称</label>
          <div id="registeredConfigNameModal" class="key-preview"></div>
        </div>
        <div class="field">
          <label>访问令牌</label>
          <div id="registeredTokenModal" class="key-preview" style="font-family: monospace;"></div>
          <small style="color:#6b7280; display:block; margin-top:0.4em;">令牌仅作脱敏展示，复制操作将使用输入框中的完整令牌。</small>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="admin-btn btn-primary" onclick="fillRegisteredInfoFromModal()">🪄 一键填入登录</button>
        <button type="button" class="admin-btn btn-secondary" onclick="copyRegisteredInfoFromModal()">📋 复制信息</button>
        <button type="button" class="admin-btn btn-danger" onclick="registerSuccessModalClose()">关闭</button>
      </div>
    </div>
  </div>

  <!-- 访问令牌输入弹窗（统一风格 + 获取指引） -->
  <div id="tokenModal" class="modal-overlay" style="display:none;">
    <div class="modal-card" style="max-width:720px;">
      <div class="modal-header">
        <h3>🔑 输入访问令牌</h3>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="tokenModalInput">GitHub 访问令牌（仅需 gist 权限）</label>
          <input id="tokenModalInput" type="password" placeholder="粘贴您的令牌，例如：ghp_..." autocomplete="off">
        </div>
        <div id="tokenModalValidation" class="url-validation" style="display:none;"></div>
        <div class="field" style="margin-top:0.6em;">
          <label>如何获取令牌</label>
          <div class="key-preview" style="font-size:0.92em; line-height:1.6;">
            1) 登录 GitHub → Settings → Developer settings → Personal access tokens<br>
            2) 选择 Classic 或 Fine-grained（推荐设置过期时间）<br>
            3) 勾选权限：<strong>gist</strong><br>
            4) 生成令牌并复制，务必妥善保管（不可泄露）
          </div>
          <div style="margin-top:0.4em;">
            <a href="https://github.com/settings/tokens" target="_blank" rel="noopener" class="summary-value" style="color:#1677ff;">👉 打开令牌管理页面</a>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="admin-btn btn-secondary" onclick="cancelTokenModal()">取消</button>
        <button type="button" class="admin-btn btn-primary" onclick="confirmTokenModal()">确定</button>
      </div>
    </div>
  </div>

  <!-- 配置名称输入弹窗（用于注册新APP应用） -->
  <div id="configNameModal" class="modal-overlay" style="display:none;">
    <div class="modal-card" style="max-width:640px;">
      <div class="modal-header">
        <h3>📝 配置名称</h3>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="configNameModalInput">请输入配置名称（将作为 Gist 描述）</label>
          <input id="configNameModalInput" placeholder="例如：我的应用配置">
        </div>
        <div id="configNameModalValidation" class="url-validation" style="display:none;"></div>
        <small style="color:#6b7280; display:block; margin-top:0.4em;">默认值：App Config (created by App-Config-Manager)。你可以自定义更易识别的名称。</small>
      </div>
      <div class="modal-actions">
        <button type="button" class="admin-btn btn-secondary" onclick="cancelConfigNameModal()">取消</button>
        <button type="button" class="admin-btn btn-primary" onclick="confirmConfigNameModal()">确定</button>
      </div>
    </div>
  </div>

  <!-- 我的Gists弹窗（统一风格） -->
  <div id="gistListModal" class="modal-overlay" style="display:none;">
    <div class="modal-card" style="max-width: 800px;">
      <div class="modal-header">
        <h3>📚 我的 Gists</h3>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="gistSearchInput">搜索</label>
          <input id="gistSearchInput" placeholder="按描述或ID过滤" oninput="filterGistList()">
        </div>
        <div id="gistListContainer" class="gist-list"></div>
        <div id="gistListValidation" class="url-validation" style="display:none;"></div>
      </div>
      <div class="modal-actions">
        <button type="button" class="admin-btn btn-secondary" onclick="loadMoreGists()">加载更多</button>
        <button type="button" class="admin-btn btn-danger" onclick="closeGistListModal()">关闭</button>
      </div>
    </div>
  </div>
</body>
</html>